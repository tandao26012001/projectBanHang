@model IEnumerable<WebBanHangOnline.Models.ShoppingCartItem>
@using WebBanHangOnline.Common;
@using System.Linq;

@{
    ViewBag.Title = "Thanh toán";
}

<!-- Single Page Header start -->
<div class="container-fluid page-header py-5">
    <h1 class="text-center text-white display-6">@ViewBag.Title</h1>
    <ol class="breadcrumb justify-content-center mb-0">
        <li class="breadcrumb-item"><a href="/trang-chu">Trang chủ</a></li>
        <li class="breadcrumb-item"><a href="/gio-hang">Giỏ hàng</a></li>
        <li class="breadcrumb-item active text-white">@ViewBag.Title</li>
    </ol>
</div>
<!-- Single Page Header End -->
@{
    decimal subTotal = 0;
    decimal shippingFee = 19000; // phí ship mặc định
}
@if (Model == null || !Model.Any())
{
    <div class="container py-5">
        <div class="alert alert-info text-center">
            Giỏ hàng của bạn hiện đang trống. <a href="/san-pham">Mua hàng ngay</a>
        </div>
    </div>
}
else
{
    <div class="container-fluid py-5">
        <div class="container py-5">
            <h1 class="mb-4">Thông tin khách hàng</h1>

            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger">@TempData["Error"]</div>
            }

            @Html.ValidationSummary(true, "", new { @class = "text-danger" })

            @using (Html.BeginForm("CheckOut", "ShoppingCart", FormMethod.Post))
            {
                @Html.AntiForgeryToken()
                <div class="row g-5">
                    <div class="col-md-12 col-lg-6 col-xl-6">
                        <div class="row">
                            <div class="col-md-12 col-lg-6">
                                <div class="form-item w-100">
                                    <label class="form-label my-3">Họ tên<sup>*</sup></label>
                                    <input type="text" name="CustomerName" class="form-control" required />
                                    @Html.ValidationMessage("CustomerName", "", new { @class = "text-danger" })
                                </div>
                            </div>
                            <div class="col-md-12 col-lg-6">
                                <div class="form-item w-100">
                                    <label class="form-label my-3">Số điện thoại<sup>*</sup></label>
                                    <input type="text" name="Phone" class="form-control" required />
                                    @Html.ValidationMessage("Phone", "", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>
                        <div class="form-item">
                            <label class="form-label my-3">Địa chỉ<sup>*</sup></label>
                            <input type="text" name="Address" class="form-control" required />
                            @Html.ValidationMessage("Address", "", new { @class = "text-danger" })
                        </div>
                        <div class="form-item">
                            <label class="form-label my-3">Email<sup>*</sup></label>
                            <input type="email" name="Email" class="form-control" required />
                            @Html.ValidationMessage("Email", "", new { @class = "text-danger" })
                        </div>
                        <div class="form-item">
                            <label class="form-label my-3">Phương thức thanh toán<sup>*</sup></label>
                            <select id="paymentMethod" class="form-control" name="TypePayment" required>
                                <option value="">Chọn phương thức thanh toán</option>
                                <option value="1">Thanh toán bằng phương thức chuyển khoản</option>
                                <option value="2">Thanh toán khi nhận hàng ( COD )</option>
                            </select>
                            @Html.ValidationMessage("TypePayment", "", new { @class = "text-danger" })
                        </div>
                        <!-- Khu vực hiển thị mã QR -->
                        <div id="qrPaymentSection" class="mt-4" style="display:none;">
                            <h5 class="mb-3 text-primary">Quét mã QR để thanh toán</h5>
                            <div class="border rounded p-3 text-center" style="max-width:300px;">
                                <img id="qrImage"
                                     src=""
                                     alt="QR Thanh toán"
                                     style="width:250px;height:250px;object-fit:contain;border-radius:10px;" />
                                <p class="mt-2 text-muted small">Quét mã bằng App ngân hàng hoặc Momo để chuyển khoản</p>
                            </div>
                        </div>
                        <div class="form-item">
                            <label class="form-label my-3">Ghi chú</label>
                            <textarea name="Note" class="form-control" spellcheck="false" rows="6" placeholder="Ghi chú cho đơn hàng (nếu có)"></textarea>
                        </div>
                    </div>

                    <div class="col-md-12 col-lg-6 col-xl-6">
                        <div class="table-responsive">
                            <table class="table">
                                <thead></thead>
                                <tbody>
                                    @foreach (var item in Model)
                                    {
                                        var total = item.Price * item.Quantity;
                                        subTotal += total;
                                    }

                                    <tr>
                                        <td colspan="5" class="py-3">
                                            @foreach (var item in Model)
                                            {
                                                <div class="d-flex align-items-center mb-3 border-bottom pb-2">
                                                    <!-- Ảnh sản phẩm -->
                                                    <div class="position-relative me-3">
                                                        <img src="@item.ProductImg"
                                                             alt="@item.ProductName"
                                                             class="img-fluid rounded"
                                                             style="width: 74px; height: 74px; object-fit: cover;" />
                                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-dark text-white"
                                                              style="font-size: 12px;">
                                                            @item.Quantity
                                                        </span>
                                                    </div>

                                                    <!-- Thông tin sản phẩm -->
                                                    <div class="flex-grow-1">
                                                        <div class="fw-semibold text-dark">@item.ProductName</div>
                                                        <div class="text-muted small">@item.ColorName / @item.Size</div>
                                                    </div>

                                                    <!-- Giá -->
                                                    <div class="text-end fw-semibold" style="min-width: 100px;">
                                                        @Common.FormatNumber(item.Price * item.Quantity, 0) đ
                                                    </div>
                                                </div>
                                            }

                                            <!-- Tổng kết -->
                                            <div class="mt-3">
                                                <div class="d-flex justify-content-between py-1">
                                                    <span>Tổng phụ</span>
                                                    <span>@Common.FormatNumber(subTotal, 0) đ</span>
                                                </div>
                                                <div class="d-flex justify-content-between py-1">
                                                    <span>Vận chuyển</span>
                                                    <span>
                                                        <del class="text-muted small">@Common.FormatNumber(shippingFee, 0) đ</del>
                                                        <span class="text-success fw-semibold ms-2">MIỄN PHÍ</span>
                                                    </span>
                                                </div>
                                                <div class="d-flex justify-content-between border-top mt-2 pt-2 fw-bold fs-5">
                                                    <span>Tổng</span>
                                                    <span>@Common.FormatNumber(subTotal, 0) đ</span>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="row g-4 text-center align-items-center justify-content-center pt-4">
                        <button type="submit" class="btn border-secondary py-3 px-4 text-uppercase w-100 text-primary">Đặt hàng</button>
                    </div>
                </div>
            }
        </div>
    </div>
}

@section scripts{
    <script>
        $(document).ready(function () {
            updateCartCount();
            function updateCartCount() {
                $.get('@Url.Action("ShowCount", "ShoppingCart")', function (data) {
                    $('#cartCount').text(data.Count);
                }).fail(function () {
                    console.error('Không thể cập nhật số lượng giỏ hàng');
                });
            }
            window.updateCartCount = updateCartCount;
        });
    </script>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const select = document.getElementById("paymentMethod");
        const qrSection = document.getElementById("qrPaymentSection");
        const qrImage = document.getElementById("qrImage");

        // 👉 Tổng tiền và mã đơn hàng (tuỳ theo model của bạn)
        const amount = @subTotal;
        const orderCode = 'ORD' + new Date().getTime(); // mã đơn tạm

        // Theo dõi thay đổi lựa chọn
        select.addEventListener("change", function () {
            const method = this.value === "1" ? "bank" : "cod"; // 1 = chuyển khoản, 2 = COD
            if (method === "bank") {
                qrSection.style.display = "block";
                qrImage.src = `/ShoppingCart/GeneratePaymentQR?amount=${amount}&orderCode=${orderCode}&method=bank`;
            } else if (method === "momo") {
                qrSection.style.display = "block";
                qrImage.src = `/ShoppingCart/GeneratePaymentQR?amount=${amount}&orderCode=${orderCode}&method=momo`;
            } else {
                qrSection.style.display = "none";
                qrImage.src = "";
            }
        });
    </script>

}
