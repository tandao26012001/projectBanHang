@model WebBanHangOnline.Models.RegisterViewModel
@{
    ViewBag.Title = "Register";
    Layout = "~/Views/Shared/_LayoutLoginClient.cshtml";
}

@* Đảm bảo bạn có jQuery + jquery.validate nếu cần ở layout *@

@using (Html.BeginForm("Register", "Account", FormMethod.Post, new { id = "registerForm" }))
{
    @Html.AntiForgeryToken()
    <!-- Sign up form -->
    <section class="signup">
        <div class="container">
            <div class="signup-content">
                <div class="signup-form">
                    <h2 class="form-title">Sign up</h2>
                    <!-- Toast container -->
                    <div id="toastContainer" class="mb-3" style="display:none;">
                        <div id="liveToast" class="toast show text-bg-primary border-0 w-100" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="d-flex justify-content-between align-items-center p-2">
                                <div id="toastMessage" class="fw-semibold"></div>
                                <button type="button" class="btn-close btn-close-white ms-2" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                        </div>
                    </div>
                    <div class="register-form">
                        <div class="form-group">
                            @*<label for="email"><i class="zmdi zmdi-email"></i></label>*@
                            <input type="email" id="Email" name="Email" class="form-control" placeholder="Nhập email..." required />
                        </div>
                        <div class="form-group form-button">
                            <input type="button" name="signup" id="btnSendCode" class="form-submit" value="Lấy mã xác nhận" />
                        </div>
                        <div class="form-group" id="verifySection" style="display:none;">
                            <div class="form-group">
                                <label for="name"><i class="zmdi zmdi-key"></i></label>
                                <input type="text" name="name" id="VerifyCode" placeholder="Nhập mã 6 chữ số..." />
                            </div>
                            <div class="form-group form-button">
                                <input type="button" id="btnVerifyCode" class="form-submit" value="Xác nhận mã" />
                            </div>
                        </div>
                        <div id="registerinformationSection" style="display:none;">
                            <div class="form-group">
                                <label for="pass"><i class="zmdi zmdi-lock"></i></label>
                                <input type="text" name="FullName" id="FullName" placeholder="Họ và tên" />
                            </div>
                            <div class="form-group">
                                <label for="pass"><i class="zmdi zmdi-lock"></i></label>
                                <input type="text" name="PhoneNumber" id="PhoneNumber" placeholder="Số điện thoại" />
                            </div>
                            <div class="form-group">
                                <label for="pass"><i class="zmdi zmdi-lock"></i></label>
                                <input type="password" name="Password" id="Password" placeholder="Mật khẩu" />
                            </div>
                            <div class="form-group">
                                <label for="re-pass"><i class="zmdi zmdi-lock-outline"></i></label>
                                <input type="password" name="ConfirmPassword" id="ConfirmPassword" placeholder="Nhập lại mật khẩu" />
                            </div>
                            <div class="form-group">
                                <input type="checkbox" name="agree-term" id="agree-term" class="agree-term" />
                                <label for="agree-term" class="label-agree-term"><span><span></span></span>I agree all statements in  <a href="#" class="term-service">Terms of service</a></label>
                            </div>
                            <div class="form-group form-button">
                                <input type="button" name="btnRegister" id="btnRegister" class="form-submit" value="Đăng ký tài khoản" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="signup-image">
                    <figure><img src="~/Content/clients/account/images/signup-image.jpg" alt="sing up image"></figure>
                    <a href="#" class="signup-image-link">Đã có tài khoản, đăng nhập ngay</a>
                </div>
            </div>
        </div>
    </section>
    <!-- Modal thông báo đăng ký -->
    <div class="modal fade" id="registerSuccessModal" tabindex="-1" aria-labelledby="registerSuccessLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header bg-success text-white rounded-top-4">
                    <h5 class="modal-title" id="registerSuccessLabel">Đăng ký thành công!</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body text-center">
                    <p id="registerSuccessMessage">Tài khoản của bạn đã được tạo thành công.</p>
                    <p>Bạn sẽ được chuyển đến trang đăng nhập sau <strong id="countdown">5</strong> giây.</p>
                    <a id="goToLogin" href="#" class="btn btn-primary mt-3">Đăng nhập ngay</a>
                </div>
            </div>
        </div>
    </div>

}
<style>
    #toastContainer .toast {
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        border-radius: 0.5rem;
        font-size: 15px;
    }

    #toastMessage a {
        color: #fff;
        text-decoration: underline;
    }
</style>
<script src="~/Scripts/jquery-3.7.1.min.js"></script>
<script src="~/Scripts/jquery.validate.min.js"></script>
<script src="~/Scripts/jquery.validate.unobtrusive.min.js"></script>

<script>
        // --- Hàm helper lấy token AntiForgery
        function getAntiForgeryToken() {
            return $('input[name="__RequestVerificationToken"]').val();
        }

        // Kiểm tra jQuery load
        if (typeof $ === 'undefined') {
            console.error('jQuery chưa được load. Vui lòng include jQuery trước script này.');
        }

        function showToast(message, type) {
            var container = $("#toastContainer");
            var toast = $("#liveToast");
            var toastBody = $("#toastMessage");

            toastBody.html(message);
            let bgClass = "text-bg-primary";
            if (type === "success") bgClass = "text-bg-success";
            else if (type === "error") bgClass = "text-bg-danger";
            else if (type === "warning") bgClass = "text-bg-warning";

            toast.removeClass("text-bg-primary text-bg-success text-bg-danger text-bg-warning")
                .addClass(bgClass);

            container.fadeIn(200);
            setTimeout(() => container.fadeOut(300), 2000);
        }

        // Send code
        $("#btnSendCode").on("click", function () {
            var email = $("#Email").val().trim();
            if (!email) { alert("Vui lòng nhập email."); return; }

            $.ajax({
                url: '@Url.Action("SendVerificationCode", "Account")',
                method: 'POST',
                data: {
                    __RequestVerificationToken: getAntiForgeryToken(),
                    email: email
                },
                success: function (res) {
                    showToast(res.message, res.messageType);
                    if (res.success) {
                        $("#verifySection").show();
                        $("#btnSendCode").prop("disabled", true); // Khóa nút gửi mã
                        showToast(res.message, "success");    // Hiện thông báo bootstrap
                    } else {
                        showToast(res.message, "warning");
                    }
                },
                error: function (xhr, status, err) {
                    alert("Lỗi khi gửi yêu cầu. Kiểm tra console/network.");
                    console.error(xhr, status, err);
                }
            });
        });

        // Verify code
        $("#btnVerifyCode").on("click", function () {
            var email = $("#Email").val().trim();
            var code = $("#VerifyCode").val().trim();
            if (!code) { $("#verifyMessage").text("Vui lòng nhập mã xác nhận."); return; }

            $.ajax({
                url: '@Url.Action("VerifyEmailCode", "Account")',
                method: 'POST',
                data: {
                    __RequestVerificationToken: getAntiForgeryToken(),
                    email: email,
                    code: code
                },
                success: function (res) {
                    $("#verifyMessage").text("");
                    if (res.success) {
                        showToast(res.message, res.messageType);
                        $("#registerinformationSection").show();
                        $("#verifySection").hide();
                        $("#btnSendCode, #btnVerifyCode").prop("disabled", true).hide();
                        $("#Email").prop("readonly", true);
                    } else {
                        showToast(res.message, "warning");
                    }
                },
                error: function (xhr) {
                    $("#verifyMessage").text("Lỗi server khi xác nhận mã.");
                    console.error(xhr);
                }
            });
        });

        // Register
        $("#btnRegister").on("click", function () {
            var data = {
                __RequestVerificationToken: getAntiForgeryToken(),
                Email: $("#Email").val().trim(),
                Password: $("#Password").val(),
                ConfirmPassword: $("#ConfirmPassword").val(),
                PhoneNumber: $("#PhoneNumber").val(),
                FullName: $("#FullName").val(),

            };

            $("#registerMessage").text("");

            $.ajax({
                url: '@Url.Action("Register", "Account")',
                method: 'POST',
                data: data,
                success: function (res) {
                if (res.success) {
                    const loginUrl = res.returnUrl || '@Url.Action("Login", "Account")';

                    // Gán lại link vào nút
                    $("#goToLogin").attr("href", loginUrl);

                    // Hiển thị modal
                    var modal = new bootstrap.Modal(document.getElementById("registerSuccessModal"));
                    modal.show();

                    // Đếm ngược 5s rồi tự chuyển
                    let seconds = 5;
                    $("#countdown").text(seconds);

                    const countdownInterval = setInterval(() => {
                        seconds--;
                        $("#countdown").text(seconds);
                        if (seconds <= 0) {
                            clearInterval(countdownInterval);
                            window.location.href = loginUrl;
                        }
                    }, 1000);
                } else {
                    // Nếu lỗi thì vẫn dùng toast
                    showToast(res.message || "Đăng ký không thành công.", res.messageType || "error");
                }
            },
                error: function (xhr) {
                    $("#registerMessage").text("Lỗi server khi đăng ký.");
                    console.error(xhr);
                }
            });
        });
</script>
