@model WebBanHangOnline.Models.RegisterViewModel
@{
    ViewBag.Title = "Register";
    Layout = "~/Views/Shared/_LayoutLoginClient.cshtml";
}

@* Đảm bảo bạn có jQuery + jquery.validate nếu cần ở layout *@

<div class="register-form">
    <h2>Đăng ký tài khoản</h2>

    @using (Html.BeginForm("Register", "Account", FormMethod.Post, new { id = "registerForm" }))
    {
        @Html.AntiForgeryToken()

        <div class="form-group">
            <label>Email</label>
            <input type="email" id="Email" name="Email" class="form-control" placeholder="Nhập email..." required />
        </div>

        <div class="form-group">
            <button type="button" id="btnSendCode" class="btn btn-primary">Gửi mã xác nhận</button>
        </div>

        <div class="form-group" id="verifySection" style="display:none;">
            <label>Mã xác nhận</label>
            <input type="text" id="VerifyCode" class="form-control" placeholder="Nhập mã 6 chữ số..." />
            <button type="button" id="btnVerifyCode" class="btn btn-success mt-2">Xác nhận mã</button>
            <div id="verifyMessage" style="margin-top:8px;color:#d9534f;"></div>
        </div>

        <div id="passwordSection" style="display:none;">
            <div class="form-group">
                <label>Mật khẩu</label>
                <input type="password" id="Password" name="Password" class="form-control" required />
            </div>
            <div class="form-group">
                <label>Nhập lại mật khẩu</label>
                <input type="password" id="ConfirmPassword" name="ConfirmPassword" class="form-control" required />
            </div>
            <div id="registerMessage" style="margin-top:8px;color:#d9534f;"></div>
            <button type="button" id="btnRegister" class="btn btn-primary mt-2">Đăng ký</button>
        </div>
    }
</div>
<script src="~/Scripts/jquery-3.7.1.min.js"></script>
<script src="~/Scripts/jquery.validate.min.js"></script>
<script src="~/Scripts/jquery.validate.unobtrusive.min.js"></script>
<script>
        // --- Hàm helper lấy token AntiForgery
        function getAntiForgeryToken() {
            return $('input[name="__RequestVerificationToken"]').val();
        }

        // Kiểm tra jQuery load
        if (typeof $ === 'undefined') {
            console.error('jQuery chưa được load. Vui lòng include jQuery trước script này.');
        }

        // Send code
        $("#btnSendCode").on("click", function () {
            var email = $("#Email").val().trim();
            if (!email) { alert("Vui lòng nhập email."); return; }

            $.ajax({
                url: '@Url.Action("SendVerificationCode", "Account")',
                method: 'POST',
                data: {
                    __RequestVerificationToken: getAntiForgeryToken(),
                    email: email
                },
                success: function (res) {
                    alert(res.message);
                    if (res.success) {
                        $("#verifySection").show();
                    }
                },
                error: function (xhr, status, err) {
                    alert("Lỗi khi gửi yêu cầu. Kiểm tra console/network.");
                    console.error(xhr, status, err);
                }
            });
        });

        // Verify code
        $("#btnVerifyCode").on("click", function () {
            var email = $("#Email").val().trim();
            var code = $("#VerifyCode").val().trim();
            if (!code) { $("#verifyMessage").text("Vui lòng nhập mã xác nhận."); return; }

            $.ajax({
                url: '@Url.Action("VerifyEmailCode", "Account")',
                method: 'POST',
                data: {
                    __RequestVerificationToken: getAntiForgeryToken(),
                    email: email,
                    code: code
                },
                success: function (res) {
                    $("#verifyMessage").text("");
                    if (res.success) {
                        alert(res.message);
                        $("#passwordSection").show();
                        $("#verifySection").hide();
                        $("#btnSendCode, #btnVerifyCode").prop("disabled", true);
                        $("#Email").prop("readonly", true);
                    } else {
                        $("#verifyMessage").text(res.message);
                    }
                },
                error: function (xhr) {
                    $("#verifyMessage").text("Lỗi server khi xác nhận mã.");
                    console.error(xhr);
                }
            });
        });

        // Register
        $("#btnRegister").on("click", function () {
            var data = {
                __RequestVerificationToken: getAntiForgeryToken(),
                Email: $("#Email").val().trim(),
                Password: $("#Password").val(),
                ConfirmPassword: $("#ConfirmPassword").val()
            };

            $("#registerMessage").text("");

            $.ajax({
                url: '@Url.Action("Register", "Account")',
                method: 'POST',
                data: data,
                success: function (res) {
                    if (res.success) {
                        // Redirect to login or wherever
                        window.location.href = res.returnUrl || '@Url.Action("Login","Account")';
                    } else {
                        $("#registerMessage").text(res.message || "Đăng ký không thành công.");
                    }
                },
                error: function (xhr) {
                    $("#registerMessage").text("Lỗi server khi đăng ký.");
                    console.error(xhr);
                }
            });
        });
</script>
