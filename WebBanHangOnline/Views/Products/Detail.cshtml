@model WebBanHangOnline.Models.EF.Product
@{
    ViewBag.Title = Model.SeoTitle;
    ViewBag.SeoKeyWord = Model.SeoKeywords ?? Model.Title;
}
<link href="~/Content/servers/css/rutgonnoidung.css" rel="stylesheet" />

<!-- Single Page Header start -->
<div class="container-fluid page-header py-5">
    <h1 class="text-center text-white display-6">Shop Detail</h1>
    <ol class="breadcrumb justify-content-center mb-0">
        <li class="breadcrumb-item"><a href="#">Home</a></li>
        <li class="breadcrumb-item"><a href="#">Pages</a></li>
        <li class="breadcrumb-item active text-white">Shop Detail</li>
    </ol>
</div>
<!-- Single Page Header End -->
<!-- Single Product Start -->
@if (Model != null)
{
    var strImge = Model.ProductImage.FirstOrDefault(x => x.IsDefault)?.ImageUrl ?? "";
    <!-- Single Product Start -->
    <div class="container-fluid py-5 mt-5">
        <div class="container py-5">
            <div class="row g-4 mb-5">
                <div class="col-lg-8 col-xl-9">
                    <div class="row g-4">
                        <!-- ẢNH SẢN PHẨM -->
                        <div class="col-lg-6">
                            <div class="border rounded">
                                <img src="@strImge" class="img-fluid w-100 rounded-top" alt="@Model.Title" loading="lazy">
                            </div>
                        </div>

                        <!-- THÔNG TIN SẢN PHẨM -->
                        <div class="col-lg-6">
                            <h4 class="fw-bold mb-3">@Model.Title</h4>
                            <p class="mb-3">Mã sản phẩm: @Model.ProductCode</p>
                            <p class="mb-3">Danh mục sản phẩm: @Model.ProductCategory.Title</p>

                            @if ((Model?.PriceSale ?? 0) > 0)
                            {
                                <h5 class="mb-3">
                                    <span class="mb-3 text-decoration-line-through">
                                        @WebBanHangOnline.Common.Common.FormatNumber(Model?.Price ?? 0, 0) VND
                                    </span>&ensp;
                                    @WebBanHangOnline.Common.Common.FormatNumber(Model?.PriceSale ?? 0, 0) VND
                                </h5>
                            }
                            else
                            {
                                <h5 class="mb-3">
                                    @WebBanHangOnline.Common.Common.FormatNumber(Model?.Price ?? 0, 0) VND
                                </h5>
                            }

                            <!-- SIZE -->
                            <div class="mb-3">
                                <label>Chọn Size:</label><br />
                                <button type="button" class="btn btn-outline-secondary btn-sm size-option" data-size="S">S</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm size-option" data-size="M">M</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm size-option" data-size="L">L</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm size-option" data-size="XL">XL</button>
                            </div>

                            <!-- Chọn MÀU -->
                            @if (Model.ProductColors != null && Model.ProductColors.Any())
                            {
                                <div class="mb-3">
                                    <label class="form-label">Chọn màu:</label>
                                    <!-- ✅ Hidden input để lưu màu hiện tại -->
                                    <input type="hidden" id="selectedColorId" value="@ViewBag.SelectedColorId" />
                                    <input type="hidden" id="selectedColorName" value="" />
                                    <div class="d-flex gap-2">
                                        @foreach (var pc in Model.ProductColors)
                                        {
                                            var colorName = pc.Color?.Name ?? "";
                                            var colorAlias = WebBanHangOnline.Models.Common.Filter.FilterChar(colorName);
                                            var isActive = (ViewBag.SelectedColor as string)?.ToLower() == colorAlias.ToLower();

                                            <a href="@Url.RouteUrl("detailProduct", new { alias = Model.Alias, color = colorAlias, id = Model.Id, colorId = pc.ColorId })"
                                               class="color-option border rounded-circle p-2 @(isActive ? "active shadow-lg border-primary" : "")"
                                               data-colorid="@pc.ColorId"
                                               data-color="@colorName"
                                               data-coloralias="@colorAlias"
                                               style="background-color:@pc.Color.HexColor; width:30px; height:30px; display:inline-block;"
                                               title="@colorName">
                                            </a>
                                        }

                                    </div>
                                </div>
                            }

                            <!-- SỐ LƯỢNG -->
                            <p class="mb-1 fw-semibold">Số lượng:</p>
                            <div class="input-group quantity mb-5" style="width: 100px;">
                                <div class="input-group-btn">
                                    <button class="btn btn-sm btn-minus rounded-circle bg-light border">
                                        <i class="fa fa-minus"></i>
                                    </button>
                                </div>
                                <input type="text" class="form-control form-control-sm text-center border-0" value="1" id="quantityInput" disabled>
                                <div class="input-group-btn">
                                    <button class="btn btn-sm btn-plus rounded-circle bg-light border">
                                        <i class="fa fa-plus"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- CÁC NÚT TÁC VỤ -->
                            <div class="action-buttons d-flex flex-column gap-2">
                                <!-- Toggle thông tin -->
                                <a href="javascript:;" id="toggleInfoBtn" class="btn border border-secondary rounded-pill px-4 py-2 mb-2 text-primary">
                                    <i class="fa fa-eye me-1 text-primary"></i>Thông tin sản phẩm
                                </a>
                                <div id="productInfo" class="border rounded p-3 bg-light" style="display: none;">
                                    <p>@Html.Raw(Model.Detail)</p>
                                </div>

                                <!-- Toggle review -->
                                <a href="javascript:;" id="toggleReviewBtn" class="btn border border-secondary rounded-pill px-4 py-2 mb-2 text-primary">
                                    <i class="fa fa-pen me-1 text-primary"></i>Viết đánh giá
                                </a>
                                <div id="reviewForm" class="border rounded p-4 bg-light" style="display: none;">
                                    @Html.Action("_Review", "Review", new { productId = Model.Id })
                                </div>
                            </div>

                            <!-- Giỏ hàng + yêu thích -->
                            <div class="action-buttons d-flex gap-2">
                                <a href="javascript:;" class="btn border border-secondary rounded-pill px-4 py-2 mb-4 text-primary btnAddToCart" data-id="@Model.Id" title="Thêm vào giỏ hàng">
                                    <i class="fa fa-shopping-bag me-1 text-primary"></i>Thêm vào giỏ hàng
                                </a>
                                <a href="javascript:;" class="btn border border-secondary rounded-pill px-4 py-2 mb-4 text-primary btnAddToWishlist" data-id="@Model.Id" title="Thêm vào yêu thích">
                                    <i class="fa fa-heart me-1 text-primary"></i>Thêm vào yêu thích
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 col-xl-3">
                    <div class="row g-4 fruite">
                        <div class="col-lg-12">
                            <h4 class="mb-4 fw-bold">Cùng Gu Của Bạn</h4>
                            <div class="d-flex align-items-center justify-content-start">
                                <div class="rounded" style="width: 100px; height: 100px;">
                                    <img src="img/featur-1.jpg" class="img-fluid rounded" alt="Image">
                                </div>
                                <div>
                                    <h6 class="mb-2">Big Banana</h6>
                                    <div class="d-flex mb-2">
                                        <i class="fa fa-star text-secondary"></i>
                                        <i class="fa fa-star text-secondary"></i>
                                        <i class="fa fa-star text-secondary"></i>
                                        <i class="fa fa-star text-secondary"></i>
                                        <i class="fa fa-star"></i>
                                    </div>
                                    <div class="d-flex mb-2">
                                        <h5 class="fw-bold me-2">2.99 $</h5>
                                        <h5 class="text-danger text-decoration-line-through">4.11 $</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-12">
                            <div class="position-relative">
                                <img src="img/banner-fruits.jpg" class="img-fluid w-100 rounded" alt="">
                                <div class="position-absolute" style="top: 50%; right: 10px; transform: translateY(-50%);">
                                    <h3 class="text-secondary fw-bold">Fresh <br> Fruits <br> Banner</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <h1 class="fw-bold mb-0">Related products</h1>
            <div class="vesitable">
                <div class="owl-carousel vegetable-carousel justify-content-center">
                    @if (ViewBag.RelatedProducts != null)
                    {
                        foreach (var item in (List<WebBanHangOnline.Models.EF.Product>)ViewBag.RelatedProducts)
                        {
                            var image = item.ProductImage.FirstOrDefault(x => x.IsDefault)?.ImageUrl ?? "~/Content/servers/img/no-image.jpg";
                            <div class="border border-primary rounded position-relative vesitable-item">
                                <div class="vesitable-img">
                                    <img src="@image" class="img-fluid w-100 rounded-top" alt="@item.Title">
                                </div>
                                <div class="text-white bg-primary px-3 py-1 rounded position-absolute" style="top: 10px; right: 10px;">
                                    @item.ProductCategory.Title
                                </div>
                                <div class="p-4 border border-secondary border-top-0 rounded-bottom">
                                    <h4 class="truncate-2-line">
                                        <a href="/chi-tiet/@item.Alias-p @item.Id" class="text-dark text-decoration-none">@item.Title</a>
                                    </h4>@* <p class="truncate-2-line">@item.Description</p>*@
                                    <br />
                                    <div class="d-flex justify-content-between flex-lg-wrap">
                                        @if (item.PriceSale > 0)
                                        {
                                            <p class="text-dark fs-5 fw-bold mb-0">
                                                @WebBanHangOnline.Common.Common.FormatNumber(item.PriceSale, 0) đ
                                                <span class="text-decoration-line-through text-danger ms-2">
                                                    @WebBanHangOnline.Common.Common.FormatNumber(item.Price, 0) đ
                                                </span>
                                            </p>
                                        }
                                        else
                                        {
                                            <p class="text-dark fs-5 fw-bold mb-0">
                                                @WebBanHangOnline.Common.Common.FormatNumber(item.Price, 0) đ
                                            </p>
                                        }
                                    </div>
                                    <!-- Nút giỏ hàng & yêu thích -->
                                    <div class="action-buttons d-flex justify-content-end gap-2 mt-auto">
                                        <a href="javascript:;" class="btn border border-secondary rounded-pill px-3 text-primary btnAddToCart" data-id="@item.Id" title="Thêm vào giỏ hàng">
                                            <i class="fa fa-shopping-bag me-1 text-primary"></i>
                                        </a>
                                        <a href="javascript:;" class="btn border border-secondary rounded-pill px-3 text-primary btnAddToWishlist" data-id="@item.Id" title="Thêm vào yêu thích">
                                            <i class="fa fa-heart me-1 text-primary"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        }
                    }

                </div>
            </div>
        </div>
    </div>
    <!-- Single Product End -->
}
else
{
    <div class="container py-5 text-center">
        <h4 class="text-danger">Sản phẩm không tồn tại hoặc đã bị xóa.</h4>
        <a href="/" class="btn btn-primary mt-3">Quay lại trang chủ</a>
    </div>
}

@section scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <script>
        // ================================
        // Xử lý tìm kiếm, lọc, phân trang
        // ================================
        $(function () {
            // Autocomplete cho search box
            $("#searchBox").autocomplete({
                source: '/Products/GetSuggestions',
                minLength: 2
            });

            // Lọc sản phẩm theo danh mục
            $(document).on('click', '.cate-filter', function () {
                var categoryId = $(this).data("id");
                loadProducts(categoryId);
            });

            // Hàm load sản phẩm
            function loadProducts(categoryId) {
                $.ajax({
                    url: '/Products/Partial_ItemsByCateId',
                    type: 'GET',
                    data: { categoryId: categoryId },
                    success: function (res) {
                        $('#product-container').html(res);
                    },
                    error: function () {
                        alert('Không thể tải sản phẩm.');
                    }
                });
            }

            // Hàm load sản phẩm kèm phân trang
            $(document).on('click', '.pagination a', function (e) {
                e.preventDefault();
                var url = $(this).attr('href');
                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function (res) {
                        $('#product-container').html(res);
                    },
                    error: function () {
                        alert('Không thể tải sản phẩm.');
                    }
                });
            });
        });


        // ================================
        // Xử lý size, màu, số lượng, giỏ hàng
        // ================================
        $(document).ready(function () {
            // --- Lấy màu hiện tại từ View ---
            let selectedColor = $("#selectedColor").val() || null;
            let selectedSize = null;

            // --- Chọn SIZE ---
            $(document).on('click', '.size-option', function () {
                $('.size-option').removeClass('active');
                $(this).addClass('active');
                selectedSize = $(this).data('size');
            });

            // --- Chọn MÀU ---
            $(document).on('click', '.color-option', function (e) {
                e.preventDefault(); // Ngăn load ngay
                let color = $(this).data('color');

                // Giữ màu vào input ẩn
                $("#selectedColor").val(color);

                // Chuyển hướng sang alias có màu (vẫn load lại trang)
                let link = $(this).attr('href');
                window.location.href = link;
            });

            // --- Nút tăng ---
            $(".btn-plus").click(function () {
                let input = $("#quantityInput");
                let current = parseInt(input.val()) || 1;
                if (current < 99) {
                    input.val(current);
                } else {
                    input.val(99);
                }
            });

            // --- Nút giảm ---
            $(".btn-minus").click(function () {
                let input = $("#quantityInput");
                let current = parseInt(input.val()) || 1;
                if (current > 1) {
                    input.val(current);
                } else {
                    input.val(1);
                }
            });
            // --- Thêm vào giỏ hàng ---
            $(".btnAddToCart").click(function () {
                let productId = $(this).data("id");
                let quantity = parseInt($("#quantityInput").val()) || 1;
                let colorId = $("#selectedColorId").val() || 0;

                if (!selectedSize) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Vui lòng chọn size!',
                        timer: 1500,
                        showConfirmButton: false
                    });
                    return;
                }

                $.ajax({
                    url: '/ShoppingCart/AddToCart',
                    type: 'POST',
                    data: {
                        id: productId,
                        quantity: quantity,
                        size: selectedSize,
                        colorId: colorId // dùng id thật
                    },
                    success: function (res) {
                        if (res.success) {
                            $('#cartCount').text(res.count);
                            Swal.fire({
                                icon: 'success',
                                title: 'Đã thêm vào giỏ hàng!',
                                text: 'Sản phẩm đã được thêm vào giỏ hàng.',
                                timer: 1500,
                                showConfirmButton: false
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi!',
                                text: res.message || 'Không thể thêm sản phẩm vào giỏ hàng.',
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi hệ thống!',
                            text: 'Vui lòng thử lại sau.',
                        });
                    }
                });
            });
            // --- Cập nhật số lượng giỏ hàng khi load ---
            updateCartCount();

            function updateCartCount() {
                $.get('@Url.Action("ShowCount", "ShoppingCart")', function (data) {
                    $('#cartCount').text(data.Count);
                }).fail(function () {
                    console.error('Không thể cập nhật số lượng giỏ hàng');
                });
            }

            window.updateCartCount = updateCartCount;
        });

        $(document).ready(function () {
            // ==== Toggle Thông tin sản phẩm ====
            $("#toggleInfoBtn").click(function () {
                $("#productInfo").slideToggle(300);
                $(this).toggleClass("active");

                if ($(this).hasClass("active")) {
                    $(this).html('<i class="fa fa-chevron-up me-1 text-primary"></i>Ẩn thông tin sản phẩm');
                } else {
                    $(this).html('<i class="fa fa-eye me-1 text-primary"></i>Thông tin sản phẩm');
                }
            });

            // ==== Toggle Viết đánh giá ====
            $("#toggleReviewBtn").click(function () {
                $("#reviewForm").slideToggle(300);
                $(this).toggleClass("active");

                if ($(this).hasClass("active")) {
                    $(this).html('<i class="fa fa-chevron-up me-1 text-primary"></i>Ẩn form đánh giá');
                } else {
                    $(this).html('<i class="fa fa-pen me-1 text-primary"></i>Viết đánh giá');
                }
            });
        });
        $(document).on('click', '.color-option', function (e) {
            e.preventDefault();

            let colorAlias = $(this).data('coloralias');
            let colorName = $(this).data('color'); // ✅ Lấy tên có dấu
            let colorId = $(this).data('colorid'); // 🟢 lấy id

            $("#selectedColor").val(colorAlias);
            $("#selectedColorName").val(colorName); // ✅ lưu tên có dấu
            $("#selectedColorId").val(colorId); // 🟢 lưu vào input ẩn

            // Chuyển sang URL chứa alias (để reload trang với màu)
            let link = $(this).attr('href');
            window.location.href = link;
        });
    </script>
}